<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SpaTopic">
<title>CellTopic analysis • SpaTopic</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="CellTopic analysis">
<meta property="og:description" content="SpaTopic">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SpaTopic</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/CellTopic_analysis.html">CellTopic analysis</a>
    <a class="dropdown-item" href="../articles/Quick_start.html">Quick start</a>
    <a class="dropdown-item" href="../articles/SpaTopic_workflow.html">SpaTopic workflow</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/compbioNJU/SpaTopic/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>CellTopic analysis</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/compbioNJU/SpaTopic/blob/HEAD/vignettes/CellTopic_analysis.Rmd" class="external-link"><code>vignettes/CellTopic_analysis.Rmd</code></a></small>
      <div class="d-none name"><code>CellTopic_analysis.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="spatopic">SpaTopic<a class="anchor" aria-label="anchor" href="#spatopic"></a>
</h2>
<div class="section level3">
<h3 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/compbioNJU/SpaTopic" class="external-link">SpaTopic</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggforce.data-imaginist.com" class="external-link">ggforce</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span></span>
<span><span class="va">my_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#66b803"</span>, <span class="st">"#E5AA9B"</span>, <span class="st">"#FABD3E"</span>, <span class="st">"#2B8CBE"</span>, <span class="st">"#DE77AE"</span>, <span class="st">"#9970AB"</span>, <span class="st">"gray"</span>, <span class="st">"#D5E4A2"</span>, <span class="st">"#71D0F5"</span>, <span class="st">"#B1746F"</span>, <span class="st">"#ADE2D0"</span>, <span class="st">"#20DE8BFF"</span>, <span class="st">"#CCDE8BFF"</span>, <span class="st">"#FFDE8BFF"</span>, <span class="st">"#FFA88BFF"</span>, <span class="st">"#FF6A8BFF"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"vignette_data/HCC_1L_obj.rda"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"vignette_data/HCC_1L_spot_celltype.rda"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cluster">cluster<a class="anchor" aria-label="anchor" href="#cluster"></a>
</h3>
<p>Here we use the clustering method ‘Seurat’, parameters are as
follows, the data has been processed by <code>SCTransform</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>HCC_1L_obj <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(HCC_1L_obj, <span class="at">assay =</span> <span class="st">"SCT"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>HCC_1L_obj <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(HCC_1L_obj, <span class="at">reduction =</span> <span class="st">"pca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>HCC_1L_obj <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(HCC_1L_obj, <span class="at">resolution =</span> <span class="fl">1.5</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Modularity Optimizer version <span class="dv">1</span>.<span class="fl">3.0</span> by Ludo Waltman and Nees Jan van Eck</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>Number of nodes<span class="sc">:</span> <span class="dv">2791</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>Number of edges<span class="sc">:</span> <span class="dv">103726</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>Running Louvain algorithm...</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>Maximum modularity <span class="cf">in</span> <span class="dv">10</span> random starts<span class="sc">:</span> <span class="fl">0.7420</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>Number of communities<span class="sc">:</span> <span class="dv">16</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>Elapsed time<span class="sc">:</span> <span class="dv">0</span> seconds</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>HCC_1L_obj <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(HCC_1L_obj, <span class="at">reduction =</span> <span class="st">"pca"</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="celltopic">CellTopic<a class="anchor" aria-label="anchor" href="#celltopic"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">HCC_1L_spot_clusters</span> <span class="op">&lt;-</span> <span class="va">HCC_1L_obj</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[</span><span class="st">"seurat_clusters"</span><span class="op">]</span></span>
<span><span class="va">result_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CellTopic.html">CellTopic</a></span><span class="op">(</span></span>
<span>  <span class="va">HCC_1L_spot_celltype</span>,</span>
<span>  <span class="va">HCC_1L_spot_clusters</span>,</span>
<span>  cluster <span class="op">=</span> <span class="st">"seurat_clusters"</span>,</span>
<span>  num_topics <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  percent <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="op">)</span></span>
<span><span class="va">HCC_1L_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/AddMetaData.html" class="external-link">AddMetaData</a></span><span class="op">(</span><span class="va">HCC_1L_obj</span>, <span class="va">result_list</span><span class="op">[[</span><span class="st">"CellTopic"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SpatialPlot.html" class="external-link">SpatialDimPlot</a></span><span class="op">(</span><span class="va">HCC_1L_obj</span>, group.by <span class="op">=</span> <span class="st">"CellTopic"</span>, image.alpha <span class="op">=</span> <span class="fl">0</span>, pt.size.factor <span class="op">=</span> <span class="fl">2.2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">my_colors</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SpatialPlot.html" class="external-link">SpatialDimPlot</a></span><span class="op">(</span><span class="va">HCC_1L_obj</span>, alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-3-1.png" width="50%"><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-3-2.png" width="50%"></p>
</div>
</div>
<div class="section level2">
<h2 id="special-spatial-domain">Special spatial domain<a class="anchor" aria-label="anchor" href="#special-spatial-domain"></a>
</h2>
<p>SpaTopic can combine cell types and spatial location of CellTopics to
analyze certain specialized spatial tissue structures in cancer, such as
Tertiary Lymphoid Structures (TLSs) and tumor boundary.</p>
<p>We can see that the slice is divided into 15 CellTopics, of which
CellTopics 1, 2, 4, and 5 belong to the cancer regions, and their main
cell types are epithelial cells.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/CellTopic_plot.html">CellTopic_plot</a></span><span class="op">(</span><span class="va">HCC_1L_obj</span>, </span>
<span>               celltype_topic <span class="op">=</span> <span class="va">result_list</span><span class="op">[[</span><span class="st">"celltype_topic"</span><span class="op">]</span><span class="op">]</span>, </span>
<span>               celltopic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"CellTopic"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               cols.highlight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#DE2D26"</span>, <span class="st">"#FEE0D2"</span><span class="op">)</span>,</span>
<span>               cols.celltype <span class="op">=</span> <span class="va">my_colors</span>, </span>
<span>               pt.size.factor <span class="op">=</span> <span class="fl">2.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
<p>CellTopic8 mainly represents the tumor boundary, and its major cell
types include fibroblast cells, pDC cells and B cells.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/CellTopic_plot.html">CellTopic_plot</a></span><span class="op">(</span><span class="va">HCC_1L_obj</span>, </span>
<span>               celltype_topic <span class="op">=</span> <span class="va">result_list</span><span class="op">[[</span><span class="st">"celltype_topic"</span><span class="op">]</span><span class="op">]</span>, </span>
<span>               celltopic <span class="op">=</span> <span class="st">"CellTopic8"</span>, </span>
<span>               cols.highlight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#DE2D26"</span>, <span class="st">"#FEE0D2"</span><span class="op">)</span>,</span>
<span>               cols.celltype <span class="op">=</span> <span class="va">my_colors</span>,</span>
<span>               pt.size.factor <span class="op">=</span> <span class="fl">2.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-5-1.png" width="288"></p>
<p>Additionally, CellTopic 7 is found in the paraneoplastic region,
predominantly consisting of plasmacytoid dendritic cells (pDCs), B
cells, and myeloid cells.</p>
<p>On the right, we observe the scoring for spots using the “<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8683021/" class="external-link">TLS50</a>”
gene set, which is considered to be the gene signature for the
identification of TLSs.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/CellTopic_plot.html">CellTopic_plot</a></span><span class="op">(</span><span class="va">HCC_1L_obj</span>, </span>
<span>               celltype_topic <span class="op">=</span> <span class="va">result_list</span><span class="op">[[</span><span class="st">"celltype_topic"</span><span class="op">]</span><span class="op">]</span>, </span>
<span>               celltopic <span class="op">=</span> <span class="st">"CellTopic7"</span>, </span>
<span>               cols.highlight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#DE2D26"</span>, <span class="st">"#FEE0D2"</span><span class="op">)</span>,</span>
<span>               cols.celltype <span class="op">=</span> <span class="va">my_colors</span>, </span>
<span>               highlight.circle <span class="op">=</span> <span class="st">"isTLS"</span>,</span>
<span>               pt.size.factor <span class="op">=</span> <span class="fl">2.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SpatialPlot.html" class="external-link">SpatialFeaturePlot</a></span><span class="op">(</span><span class="va">HCC_1L_obj</span>, features <span class="op">=</span> <span class="st">"scores"</span>, pt.size.factor <span class="op">=</span> <span class="fl">2.2</span>, image.alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"TLS50"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-6-1.png" width="50%"><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-6-2.png" width="50%"></p>
</div>
<div class="section level2">
<h2 id="meta-analysis">Meta analysis<a class="anchor" aria-label="anchor" href="#meta-analysis"></a>
</h2>
<div class="section level3">
<h3 id="load-data-1">Load data<a class="anchor" aria-label="anchor" href="#load-data-1"></a>
</h3>
<p>Presented here is a meta-analysis of the CellTopic-celltypes data
derived from four primary colorectal cancer cases as well as two
corresponding metastatic liver cancer instances.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"vignette_data/Meta_CellTopic.rda"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>Meta_CellTopic[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                  C1_CellTopic1 C1_CellTopic2 C1_CellTopic3 C1_CellTopic4</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>T01_cycling_TNK      <span class="fl">0.01354725</span>   <span class="fl">0.022351251</span>   <span class="fl">0.022554421</span>   <span class="fl">0.017575393</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>B07_plasma_PPIB      <span class="fl">0.02185837</span>   <span class="fl">0.018740898</span>   <span class="fl">0.018035048</span>   <span class="fl">0.006827589</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>M02_Mac_CXCL9        <span class="fl">0.02372333</span>   <span class="fl">0.006066737</span>   <span class="fl">0.008488789</span>   <span class="fl">0.009032274</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>M08_cycling_MKI67    <span class="fl">0.01309684</span>   <span class="fl">0.013551056</span>   <span class="fl">0.022641684</span>   <span class="fl">0.016111530</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>B04_plasma_IGHG2     <span class="fl">0.03035225</span>   <span class="fl">0.009415768</span>   <span class="fl">0.005488518</span>   <span class="fl">0.008393596</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                  C1_CellTopic5</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>T01_cycling_TNK     <span class="fl">0.016782494</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>B07_plasma_PPIB     <span class="fl">0.023410894</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>M02_Mac_CXCL9       <span class="fl">0.006921123</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>M08_cycling_MKI67   <span class="fl">0.022835434</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>B04_plasma_IGHG2    <span class="fl">0.024964639</span></span></code></pre></div>
<p>Initially, we calculate the correlation among the CellTopics. Based
on the complete clustering outcomes, we identify CellTopics that
comprise similar cell types and subsequently define these clusters as
MetaTopics.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">Meta_CellTopic</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span><span class="va">corr</span>,</span>
<span>         border_color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>         scale <span class="op">=</span> <span class="st">"none"</span>, </span>
<span>         cluster_rows <span class="op">=</span> <span class="cn">T</span>,</span>
<span>         cluster_cols <span class="op">=</span> <span class="cn">T</span>,</span>
<span>         legend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>         show_rownames <span class="op">=</span> <span class="cn">T</span>,</span>
<span>         show_colnames <span class="op">=</span> <span class="cn">T</span>,</span>
<span>         fontsize <span class="op">=</span> <span class="fl">8</span>, </span>
<span>         cutree_rows <span class="op">=</span> <span class="fl">7</span>,</span>
<span>         cutree_cols <span class="op">=</span> <span class="fl">7</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-8-1.png" width="768">
Utilizing the Wilcoxon test, we discerned the cell types that exhibit
high expression for each MetaTopic. The heatmap below displays the mean
expression of each cell type within each MetaTopic, with the p-values
indicating the significance of the differences in expression levels.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>Attaching package<span class="sc">:</span> <span class="st">'reshape2'</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>The following object is masked from <span class="st">'package:tidyr'</span><span class="sc">:</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    smiths</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>row_cluster <span class="ot">&lt;-</span> <span class="fu">cutree</span>(p<span class="sc">$</span>tree_row,<span class="at">k=</span><span class="dv">7</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(row_cluster) <span class="ot">&lt;-</span> <span class="st">"cluster"</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>row_cluster<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"M"</span>, row_cluster<span class="sc">$</span>cluster)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>row_cluster<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_.*"</span>, <span class="st">""</span>, <span class="fu">rownames</span>(row_cluster))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>Meta_CellTopic_cluster <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="fu">as.data.frame</span>(<span class="fu">t</span>(Meta_CellTopic)), row_cluster, <span class="at">by =</span> <span class="dv">0</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>Meta_CellTopic_cluster_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(Meta_CellTopic_cluster, <span class="at">id.vars =</span> <span class="fu">c</span>(<span class="st">"cluster"</span>, <span class="st">"Row.names"</span>, <span class="st">"sample"</span>))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Meta_CellTopic_cluster_long) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cluster"</span>, <span class="st">"CellTopic"</span>, <span class="st">"sample"</span>, <span class="st">"celltype_min"</span>, <span class="st">"value"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>Meta_CellTopic_cluster_long<span class="sc">$</span>CellTopic <span class="ot">&lt;-</span> <span class="fu">as.character</span>(Meta_CellTopic_cluster_long<span class="sc">$</span>CellTopic)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>Meta_CellTopic_cluster_long<span class="sc">$</span>celltype_min <span class="ot">&lt;-</span> <span class="fu">as.character</span>(Meta_CellTopic_cluster_long<span class="sc">$</span>celltype_min)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> Meta_CellTopic_cluster_long <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster, celltype_min) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(value, <span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(celltype_min, mean) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="at">var =</span> <span class="st">"cluster"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a> [1m [22m<span class="st">`</span><span class="at">summarise()</span><span class="st">`</span> has grouped output by <span class="st">'cluster'</span>. You can override using the</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">.groups</span><span class="st">`</span> argument.</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>df_p <span class="ot">&lt;-</span> <span class="fu">unique</span>(Meta_CellTopic_cluster_long<span class="sc">$</span>celltype_min) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var =</span> <span class="st">"."</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>ct_n <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(ct <span class="cf">in</span> <span class="fu">unique</span>(Meta_CellTopic_cluster_long<span class="sc">$</span>celltype_min)){</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  all <span class="ot">&lt;-</span> Meta_CellTopic_cluster_long <span class="sc">%&gt;%</span> <span class="fu">subset</span>(celltype_min <span class="sc">==</span> ct)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  cls_n <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(cls <span class="cf">in</span> <span class="fu">unique</span>(Meta_CellTopic_cluster_long<span class="sc">$</span>cluster)){</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>      select <span class="ot">&lt;-</span> Meta_CellTopic_cluster_long <span class="sc">%&gt;%</span> <span class="fu">subset</span>(celltype_min <span class="sc">==</span> ct <span class="sc">&amp;</span> cluster <span class="sc">==</span> cls)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> <span class="fu">wilcox.test</span>(select<span class="sc">$</span>value, all<span class="sc">$</span>value, <span class="at">alternative =</span> <span class="st">"greater"</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>      p <span class="ot">&lt;-</span> p<span class="sc">$</span>p.value</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>      df_p[ct_n,cls_n] <span class="ot">&lt;-</span> p</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>      cls_n <span class="ot">&lt;-</span> cls_n <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  ct_n <span class="ot">&lt;-</span> ct_n <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_p) <span class="ot">&lt;-</span> <span class="fu">unique</span>(Meta_CellTopic_cluster_long<span class="sc">$</span>cluster)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>df_pp <span class="ot">&lt;-</span> df_p <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>df_pp_cluster <span class="ot">&lt;-</span> <span class="fu">apply</span>(df_pp, <span class="dv">2</span>, <span class="cf">function</span>(x){<span class="fu">ifelse</span>(<span class="fu">min</span>(x) <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="fu">return</span>(<span class="fu">which.min</span>(x)), <span class="fu">return</span>(<span class="st">"none"</span>))}) <span class="sc">%&gt;%</span> </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>df_pp_cluster_name <span class="ot">&lt;-</span> <span class="fu">rownames</span>(df_pp_cluster)[<span class="fu">order</span>(df_pp_cluster<span class="sc">$</span>.)]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>df_pp <span class="ot">&lt;-</span> df_pp[,df_pp_cluster_name]</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>df_pp_cluster <span class="ot">&lt;-</span> <span class="fu">apply</span>(df_pp, <span class="dv">2</span>, <span class="cf">function</span>(x){<span class="fu">ifelse</span>(<span class="fu">min</span>(x) <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="fu">return</span>(<span class="fu">which.min</span>(x)), <span class="fu">return</span>(<span class="st">"none"</span>))}) <span class="sc">%&gt;%</span> </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>df_pp_cluster<span class="sc">$</span>. <span class="ot">&lt;-</span> <span class="fu">as.character</span>(df_pp_cluster<span class="sc">$</span>.)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_pp_cluster) <span class="ot">&lt;-</span> <span class="st">"high in MetaTopics"</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>df_pp_cluster<span class="sc">$</span><span class="st">`</span><span class="at">high in MetaTopics</span><span class="st">`</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a> [<span class="dv">1</span>] <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"1"</span>    <span class="st">"2"</span>   </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>[<span class="dv">11</span>] <span class="st">"2"</span>    <span class="st">"2"</span>    <span class="st">"2"</span>    <span class="st">"2"</span>    <span class="st">"2"</span>    <span class="st">"2"</span>    <span class="st">"3"</span>    <span class="st">"3"</span>    <span class="st">"3"</span>    <span class="st">"3"</span>   </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>[<span class="dv">21</span>] <span class="st">"3"</span>    <span class="st">"4"</span>    <span class="st">"4"</span>    <span class="st">"4"</span>    <span class="st">"4"</span>    <span class="st">"5"</span>    <span class="st">"5"</span>    <span class="st">"5"</span>    <span class="st">"5"</span>    <span class="st">"5"</span>   </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>[<span class="dv">31</span>] <span class="st">"5"</span>    <span class="st">"5"</span>    <span class="st">"5"</span>    <span class="st">"5"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>   </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>[<span class="dv">41</span>] <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"6"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>   </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>[<span class="dv">51</span>] <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"7"</span>    <span class="st">"none"</span> <span class="st">"none"</span> <span class="st">"none"</span> <span class="st">"none"</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>[<span class="dv">61</span>] <span class="st">"none"</span> <span class="st">"none"</span> <span class="st">"none"</span> <span class="st">"none"</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>mycolor <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#f94144"</span>, <span class="st">"#f8961e"</span>, <span class="st">"#f7f31c"</span>, <span class="st">"#77bb43"</span>, <span class="st">"#429f9c"</span>, <span class="st">"#3574b8"</span>, <span class="st">"#bb3892"</span>, <span class="st">"grey"</span>)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(mycolor) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5"</span>, <span class="st">"6"</span>, <span class="st">"7"</span>, <span class="st">"none"</span>)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>df[,df_pp_cluster_name] <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pheatmap</span>(<span class="at">border_color =</span> <span class="st">"black"</span>, <span class="at">scale =</span> <span class="st">"none"</span>, <span class="at">legend =</span> <span class="cn">TRUE</span>, </span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">cellwidth =</span> <span class="dv">15</span>, <span class="at">cellheight =</span> <span class="dv">15</span>,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster_rows =</span> F, <span class="at">cluster_cols =</span> F, </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_rownames =</span> T, <span class="at">show_colnames =</span> T,</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontsize =</span> <span class="dv">8</span>, <span class="at">fontsize_number =</span> <span class="dv">9</span>, <span class="at">number_color =</span> <span class="st">"black"</span>, </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">display_numbers =</span> <span class="fu">t</span>(<span class="fu">matrix</span>(<span class="fu">ifelse</span>(df_pp <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="fu">ifelse</span>(df_pp <span class="sc">&lt;=</span> <span class="fl">0.01</span>, <span class="st">"***"</span>, <span class="st">"*"</span>), <span class="st">""</span>), <span class="fu">nrow</span>(df_pp))),</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">gaps_row =</span> <span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">16</span>,<span class="dv">21</span>,<span class="dv">25</span>,<span class="dv">34</span>,<span class="dv">45</span>,<span class="dv">56</span>),</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_row =</span> df_pp_cluster,</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">annotation_colors =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">high in MetaTopics</span><span class="st">`</span> <span class="ot">=</span> mycolor),</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">angle_col =</span> <span class="dv">90</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
</div>
</div>
<div class="section level2">
<h2 id="cell-cell-communication">Cell-Cell communication<a class="anchor" aria-label="anchor" href="#cell-cell-communication"></a>
</h2>
<p>We can delve deeper into the complexities of the tumor
microenvironment by analyzing the communication among different
CellTopics. Employ the <a href="https://github.com/jinworks/CellChat" class="external-link">CellChat</a> tool to
elucidate the dynamics of cell communication across spatial domains.</p>
<div class="section level3">
<h3 id="load-data-2">load data<a class="anchor" aria-label="anchor" href="#load-data-2"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"spot_celltype"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"spot_clusters"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"vignette_data/PDAC_obj.rda"</span><span class="op">)</span></span>
<span><span class="va">result_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CellTopic.html">CellTopic</a></span><span class="op">(</span><span class="va">spot_celltype</span>, <span class="va">spot_clusters</span>, cluster <span class="op">=</span> <span class="st">"spatial.cluster"</span>, num_topics <span class="op">=</span> <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">PDAC_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/AddMetaData.html" class="external-link">AddMetaData</a></span><span class="op">(</span><span class="va">PDAC_obj</span>, <span class="va">result_list</span><span class="op">[[</span><span class="st">"CellTopic"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CellChat)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create cellchat object</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>data.input <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(PDAC_obj, <span class="at">assay =</span> <span class="st">"Spatial"</span>, <span class="at">slot =</span> <span class="st">"data"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>identity <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">group =</span>PDAC_obj<span class="sc">$</span>CellTopic, <span class="at">row.names =</span> <span class="fu">names</span>(PDAC_obj<span class="sc">$</span>CellTopic))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>cellchat <span class="ot">&lt;-</span> <span class="fu">createCellChat</span>(<span class="at">object =</span> data.input, <span class="at">meta =</span> identity, <span class="at">group.by =</span> <span class="st">"group"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"Create a CellChat object from a data matrix"</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>Set cell identities <span class="cf">for</span> the new CellChat object </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>The cell groups used <span class="cf">for</span> CellChat analysis are  CellTopic1 CellTopic2 CellTopic3 CellTopic4 </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Selective ligand receptor database</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>cellchat<span class="sc">@</span>DB <span class="ot">&lt;-</span> CellChatDB.human</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>cellchat <span class="ot">&lt;-</span> <span class="fu">subsetData</span>(cellchat)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculation</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>cellchat <span class="ot">&lt;-</span> <span class="fu">identifyOverExpressedGenes</span>(cellchat)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>cellchat <span class="ot">&lt;-</span> <span class="fu">identifyOverExpressedInteractions</span>(cellchat)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>cellchat <span class="ot">&lt;-</span> <span class="fu">projectData</span>(cellchat, PPI.human)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#cellchat &lt;- filterCommunication(cellchat, min.cells = 10) # Do not filter spot</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>cellchat <span class="ot">&lt;-</span> <span class="fu">computeCommunProb</span>(cellchat, <span class="at">raw.use =</span> <span class="cn">FALSE</span>, <span class="at">population.size =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>triMean is used <span class="cf">for</span> calculating the average gene expression per cell group. </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"&gt;&gt;&gt; Run CellChat on sc/snRNA-seq data &lt;&lt;&lt; [2024-03-05 23:53:19.438885]"</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"&gt;&gt;&gt; CellChat inference is done. Parameter values are stored in `object@options$parameter` &lt;&lt;&lt; [2024-03-05 23:54:04.21858]"</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>cellchat <span class="ot">&lt;-</span> <span class="fu">computeCommunProbPathway</span>(cellchat)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>df.net <span class="ot">&lt;-</span> <span class="fu">subsetCommunication</span>(cellchat)</span></code></pre></div>
<p>Communication between different spatial domains from the perspective
of pathway.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df.netp</span> <span class="op">&lt;-</span> <span class="fu">subsetCommunication</span><span class="op">(</span><span class="va">cellchat</span>, slot.name <span class="op">=</span> <span class="st">"netP"</span><span class="op">)</span></span>
<span><span class="va">df.netp</span><span class="op">$</span><span class="va">sTot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">df.netp</span><span class="op">$</span><span class="va">source</span>, <span class="st">" -&gt; "</span>, <span class="va">df.netp</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="va">df.netp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">df.netp</span>, <span class="va">sTot</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CellTopic1 -&gt; CellTopic1"</span>,<span class="st">"CellTopic1 -&gt; CellTopic2"</span>,<span class="st">"CellTopic1 -&gt; CellTopic3"</span>,<span class="st">"CellTopic1 -&gt; CellTopic4"</span>,<span class="st">"CellTopic2 -&gt; CellTopic1"</span>,<span class="st">"CellTopic3 -&gt; CellTopic1"</span>,<span class="st">"CellTopic4 -&gt; CellTopic1"</span>,<span class="st">"CellTopic2 -&gt; CellTopic4"</span>,<span class="st">"CellTopic4 -&gt; CellTopic2"</span>,<span class="st">"CellTopic2 -&gt; CellTopic2"</span>,<span class="st">"CellTopic3 -&gt; CellTopic3"</span>,<span class="st">"CellTopic4 -&gt; CellTopic4"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df.netp</span><span class="op">$</span><span class="va">sTot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df.netp</span><span class="op">$</span><span class="va">sTot</span>,levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CellTopic2 -&gt; CellTopic4"</span>,<span class="st">"CellTopic4 -&gt; CellTopic2"</span>,<span class="st">"CellTopic1 -&gt; CellTopic2"</span>,<span class="st">"CellTopic2 -&gt; CellTopic1"</span>,<span class="st">"CellTopic1 -&gt; CellTopic3"</span>,<span class="st">"CellTopic3 -&gt; CellTopic1"</span>,<span class="st">"CellTopic1 -&gt; CellTopic4"</span>,<span class="st">"CellTopic4 -&gt; CellTopic1"</span>,<span class="st">"CellTopic1 -&gt; CellTopic1"</span>,<span class="st">"CellTopic2 -&gt; CellTopic2"</span>,<span class="st">"CellTopic3 -&gt; CellTopic3"</span>,<span class="st">"CellTopic4 -&gt; CellTopic4"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df.netp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">df.netp</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>, </span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>, </span>
<span>    pathway_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"VTN"</span>,<span class="st">"VTN"</span>,<span class="st">"VTN"</span><span class="op">)</span>, <span class="co"># It's just for showing the parts without communication, "VTN" has no particularity.</span></span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, </span>
<span>    pval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>, </span>
<span>    sTot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CellTopic1 -&gt; CellTopic2"</span>,<span class="st">"CellTopic2 -&gt; CellTopic1"</span>,<span class="st">"CellTopic3 -&gt; CellTopic1"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">'RColorBrewer'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df.netp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">sTot</span>, y<span class="op">=</span><span class="va">pathway_name</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">pval</span>, color<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size</a></span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">2</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">df.netp</span><span class="op">$</span><span class="va">pval</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df.netp</span><span class="op">$</span><span class="va">pval</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"p&lt;0.01"</span>,<span class="st">"0.01&lt;p&lt;0.05"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_colour_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Spectral"</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low"</span>,<span class="st">"high"</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">df.netp</span><span class="op">$</span><span class="va">prob</span><span class="op">[</span><span class="va">df.netp</span><span class="op">$</span><span class="va">prob</span><span class="op">!=</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">df.netp</span><span class="op">$</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>size <span class="op">=</span> <span class="st">"p-value"</span>, color <span class="op">=</span> <span class="st">"Commun.prob"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CellTopic_analysis_files/figure-html/unnamed-chunk-14-1.png" width="384"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Yuelei Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
